#!/bin/sh

CFLAGS=${CFLAGS:-}
LDFLAGS=${LDFLAGS:-}
LIBS=
EXE=${EXE:-run}

src() {
    find . -name '*.c' | tr ' ' '\n' | sed 's|^\./||'
}

OBJ=$(src | sed 's/\.c$/.o/g' | tr '\n' ' ')

repl() {
    sed -e "s/^$1.*$/$1 = $2/"
}

MKFILE=Makefile
OFILE=${*:-$MKFILE}
TMPFILE=tmp.mk

[ "${OFILE}" = - ] && OFILE=/dev/stdout

for lib in ${LIBS}; do
    LDFLAGS="${LDFLAGS}-l${lib} "
done

repl CFLAGS "${CFLAGS}" < ${MKFILE} |
    repl LDFLAGS "${LDFLAGS}"       |
    repl OBJ     "${OBJ}"           |
    repl CFLAGS  "${CFLAGS}"        |
    repl EXE     "${EXE}"           > ${TMPFILE}

echo "$0 > ${OFILE}"

cat ${TMPFILE} > "${OFILE}"
rm ${TMPFILE}
